<html>
  <head>
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <meta name="author" content="Alexander Lachmann">
    <title>Elysium</title>
    
    <link rel="icon" href="images/elysium.png?v=3" type="image/png">
    
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.js"></script> 
    <script src="js/jqueryform.js"></script> 
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/css.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretty-checkbox@3.0/dist/pretty-checkbox.min2.css">
    
    <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap.min.js"></script>
    
    <script src="https://rawgit.com/enyo/dropzone/master/dist/dropzone.js"></script>
    <link rel="stylesheet" href="https://rawgit.com/enyo/dropzone/master/dist/dropzone.css">

  </head>
  <body style="padding: 50px;">
    
    <div class="row">
    <div class="col-lg-4">
    <div class="card mb-4 box-shadow">
        <div class="card-header">
            <h4 class="my-0 font-weight-normal">Upload Fastq or Fastq.gz</h4>
        </div>
        
        <div class="card-body">
            <div id="logininfo">
                This is a demo page for the Charon file upload system and automated alignment pipeline. The implementation allows cryptographically managed file upload to 
                predefined cloud repositories for users without accounts at cloud providers. Cloudalignment allows count file creation from user data.<hr>
                
                <form id="userform">
                    <label for="uname">Username</label>
                    <input id="uname" type="text" name="username" value="" class="form-control" required><br>
                    <label for="pass">Password</label>
                    <input id="pass" type="password" name="password" value="" class="form-control" required>
                </form>
                <button type="button" id="loginbutton" class="btn btn-lg btn-block btn-outline-primary" onclick="login();">Login</button>
            </div>
            
            <form id="dataform" action="x" method="POST" enctype="multipart/form-data">
                <input id="uid" type="hidden" name="key" value="x">
                <input id="cid" type="hidden" name="AWSAccessKeyId" value="x">
                <input type="hidden" name="acl" value="private">
                <input type="hidden" name="success_action_redirect" value="success.html">
                <input id="policy" type="hidden" name="policy" value="x">
                <input id="signature" type="hidden" name="signature" value="x">
                <input type="hidden" name="Content-Type" value="application/octet-stream">
                
                <h2>File to upload to S3</h2>
                <input name="file" type="file">
                <br><br>
                <button type="button" id="loginbutton" class="btn btn-lg btn-block btn-outline-primary" onclick="upload();">Upload File</button>
            </form>
            
            <div id="prbar" class="progress" style="height: 30px;">
                <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            
            <hr>
            
            <div id="status"></div>
            <div id="userfiles"></div>
            
            <div id="submitjob">
              <hr>
              <form>
                
                <div class="form-group row">
                  <label for="colFormLabel" class="col-sm-3 col-form-label">Output</label>
                  <div class="col-sm-9">
                    <input type="text" class="form-control" id="outname" placeholder="Output file name">
                  </div>
                </div>
                
                <div class="form-group row">
                  <label for="file1" class="col-sm-1 col-form-label"><img src="images/file1.png"></label>
                  <div class="col-sm-11">
                    <input type="text" readonly class="form-control-plaintext" id="file1" value="">
                  </div>
                </div>
                
                <div class="form-group row" id="file2field">
                  <label for="file2" class="col-sm-1 col-form-label"><img src="images/file2.png"></label>
                  <div class="col-sm-11">
                    <input type="text" readonly class="form-control-plaintext" id="file2" value="">
                  </div>
                </div>
                
                <div class="form-group row">
                  <label for="colFormLabelLg" class="col-sm-3 col-form-label">Species</label>
                  <div class="col-sm-9">
                    <select class="custom-select my-1 mr-sm-2" id="organismselector">
                      <option value="1">Human</option>
                      <option value="2">Mouse</option>
                    </select>
                  </div>
                </div>
                <button type="button" id="jobcreate" class="btn btn-lg btn-block btn-outline-warning" onclick="createjob();">Submit Job</button>
              </form>
              
            </div>
        </div>
    </div>
    
    </div>
    
    <div class="col-sm-8">
      <div class="card mb-4 box-shadow">
          <div class="card-header">
              <h4 class="my-0 font-weight-normal">Job status queue</h4>
          </div>
          
          <div id="jobstatus" class="card-body"></div>
      </div>
      </div>
    </div>
  <script type="text/javascript">
    
    usernamebuffer = "";
    passbuffer = "";
    
    $("#dataform").toggle();
    $("#prbar").toggle();
    $("#submitjob").hide();
    $("#file2field").toggle();
    //$("#submitjob").toggle();
    
    function listStatus(username, passwd){
        $.getJSON( "https://amp.pharm.mssm.edu/cloudalignment/progress?username="+username+"&password="+passwd, function( data ) {
            
            var tabletext = "<table id='tablestate' class='table table-striped table-bordered'><thead><tr><th>Status</th><th>Data</th><th>Prefix</th><th>Organism</th><th>Creation Date</th></tr><tbody>";
            
            for (var key in data) {
              if (data.hasOwnProperty(key)) {
                  datalink = data[key]["datalink"];
                  dl = datalink.split(";");
                  
                  if(dl.length > 1){
                    fileinfo = "<img src=\"images/file1.png\"> "+dl[0]+"<br><img src=\"images/file2.png\"> "+dl[1];
                  }
                  else{
                    fileinfo = "<img src=\"images/file1.png\"> "+dl[0]
                  }
                  creationdate = data[key]["creationdate"];
                  outname = data[key]["outname"];
                  organism = data[key]["organism"];
                  status = data[key]["status"];
                  user = data[key]["user"];
                  
                  if(status == "waiting"){
                    statusline = "<img src=\"images/pending.png\" width=\"40\" alt=\"pending\">";
                  }
                  else if(status == "submitted"){
                    statusline = "<img src=\"images/submitted.png\" width=\"40\" alt=\"processing\">";
                  }
                  else if(status == "completed"){
                    statusline = "<img src=\"images/completed.png\" width=\"40\" alt=\"completed\">";
                  }
                  else if(status == "failed"){
                    statusline = "<img src=\"images/error.png\" width=\"40\" alt=\"failed\">";
                  }
                  if(status == "completed"){
                    outfiles = "<a href=\"https://s3.amazonaws.com/biodos/"+user+"/"+outname+"_transcript.tsv\">Transcript Counts</a>";
                    outfiles += "<br><a href=\"https://s3.amazonaws.com/biodos/"+user+"/"+outname+"_gene.tsv\">Gene Counts</a>";
                    outfiles += "<br><a href=\"https://s3.amazonaws.com/biodos/"+user+"/"+outname+"_qc.tsv\">Alignment Info</a>";
                    tabletext += "<tr><td>"+statusline+"</td><td>"+fileinfo+"</td><td>"+outfiles+"</td><td>"+organism+"</td><td>"+creationdate+"</td></tr>";
                  }
                  else{
                    tabletext += "<tr><td>"+statusline+"</td><td>"+fileinfo+"</td><td>"+outname+"</td><td>"+organism+"</td><td>"+creationdate+"</td></tr>";
                  }
               }
            }
            
            tabletext += "</tbody></table>";
            
            $("#jobstatus").html(tabletext);
            $("#jobstatus").show();
        });
    }
    
    function login(){
        
        username = $("#uname").val();
        passwd = $("#pass").val();
        
        if(!username){
          username = usernamebuffer;
          passwd = passbuffer;
        }
        
        usernamebuffer = username;
        passbuffer = passwd;
        
        $.getJSON( "https://amp.pharm.mssm.edu/charon/login?username="+username+"&password="+passwd, function( data ) {
            
            if(data["status"] == "success"){
                $("#dataform").toggle();
                $("#logininfo").html("<h2>Logged in as "+username+"</h2>File uploads will be managed through user control to S3.<hr>");
                checkFiles(username, passwd);
                listStatus(username, passwd);
            }
            else{
                $('#status').html("<font style=\"color: red;\">Login failed</font>");
            }
        });
    }
    
    function upload(){
      
      username = usernamebuffer;
      passwd = passbuffer;
      
      $.getJSON( "https://amp.pharm.mssm.edu/charon/signpolicy?username="+username+"&password="+passwd, function( data ) {
          
          var items = [];
          
          $.each( data, function( key, val ) {
            
            if(key == "uid"){
                $('#uid').val(val+"/${filename}");
            }
            else if(key == "cid"){
                $('#cid').val(val);
            }
            else if(key == "bucket"){
                $('#dataform').attr("action", "https://"+val+".s3.amazonaws.com/");
            }
            else if(key == "policy"){
                $('#policy').val(val);
            }
            else if(key == "signature"){
                $('#signature').val(val);
            }
          });
          
          var bar = $('.bar');
          var percent = $('.progress-bar');
          var status = $('#status');
          
          $('#dataform').ajaxForm({
              beforeSend: function() {
                  status.empty();
                  var percentVal = '0%';
                  bar.width(percentVal);
                  percent.html(percentVal);
                  $("#dataform").toggle();
                  $("#prbar").toggle();
              },
              uploadProgress: function(event, position, total, percentComplete) {
                  var percentVal = percentComplete + '%';
                  bar.width(percentVal);
                  percent.html(percentVal);
                  percent.attr("aria-valuenow", percentComplete);
                  percent.css("width", percentVal);
              },
              complete: function(xhr) {
                  status.html(xhr.responseText);
                  $("#dataform").toggle();
                  $("#prbar").toggle();
                  checkFiles(username, passwd);
              }
          });
          $('#dataform').submit();
       });
    }
    
    function createjob(){
      
      organismbuff = $('#organismselector').find(":selected").text();
      
      if($('input:checked').length == 1) {
        url = "https://amp.pharm.mssm.edu/cloudalignment/createjob?username="+usernamebuffer+"&password="+passbuffer+"&outname="+$("#outname").val()+"&file1="+$("#file1").val()+"&organism="+organismbuff.toLowerCase();
      }
      else if($('input:checked').length == 2) {
        url = "https://amp.pharm.mssm.edu/cloudalignment/createjob?username="+usernamebuffer+"&password="+passbuffer+"&outname="+$("#outname").val()+"&file1="+$("#file1").val()+"&file2="+$("#file2").val()+"&organism="+organismbuff.toLowerCase();
      }
      
      $.getJSON( url, function( data ) {
        $("#uname").val(usernamebuffer);
        $("#pass").val(passbuffer);
        
        login();
      });
    }
    
    function checkFiles(username, passwd){
        $.getJSON( "https://amp.pharm.mssm.edu/charon/files?username="+username+"&password="+passwd, function( data ) {
            var fileStr = "";
            var fileStr2 = "";
            filename = data["filenames"];
            filesize = data["filesize"];
            
            counter = 0
            for(i=0; i<filename.length; i++){
              if(filename[i].includes(".fastq")){
                counter = counter + 1;
                fstr = "<span id=\"fn"+counter+"\">"+filename[i]+"</span><span style=\"float:right;\"><font color=\"grey\">"+filesize[i]+"</font></span>";
                fstr = "<label class=\"container\">"+fstr+"<input id=\"c"+counter+"\" class=\"seqcheck\" type=\"checkbox\" onclick=\"checkBox("+counter+")\"><span id=\"cm"+counter+"\" class=\"checkmark\"></span></label>"
                fileStr += fstr;
              }
              else{
                //fstr = filename[i]+" <span style=\"float:right;\"><font color=\"grey\">"+filesize[i]+"</font></span><br>";
                //fstr = "<label class=\"container\">"+fstr+"</label>"
                //fileStr2 += filename[i]+" <span style=\"float:right;\"><font color=\"grey\">"+filesize[i]+"</font></span><br>";
              }
            }
            
            $("#userfiles").html(fileStr+""+fileStr2);
        });
    }
    
    var limit = 2;
    function checkBox(num){
      
      if($('input:checked').length == 0) {
        $("#submitjob").hide();
      }
      else{
        $("#submitjob").show();
      }
      
      if($('input:checked').length > 1) {
        $("#file2field").show();
      }
      else{
        $("#file2field").hide();
      }
      
      
      if($('input:checked').length > 2) {
           $('#c'+num).attr('checked', false);
      }
      else{
        $('#cm'+num).html("");
      }
      
      i = 0;
      $('input:checked').each(function(index, value) {
         i = i+1;
         console.log(i+" - "+value.id);
         console.log($('#fn'+value.id.replace("c", "")).html());
         $("#file"+i).val($('#fn'+value.id.replace("c", "")).html());
         $('#cm'+value.id.replace("c", "")).html(""+i);
      });
      
    }
  </script>

  </body>
</html>
